{
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "description": "Flight counts by origin with full pagination + stable whiskers",
  "width": 800,
  "height": 400,
  "padding": 5,

  "signals": [
    { "name": "pageSize", "value": 10},
    {
      "name": "page",
      "value": 0,
      "on": [
        { "events": { "type": "click", "markname": "first-button" }, "update": "0" },
        { "events": { "type": "click", "markname": "prev-button" }, "update": "clamp(page - 1, 0, maxPage)" },
        { "events": { "type": "click", "markname": "next-button" }, "update": "clamp(page + 1, 0, maxPage)" },
        { "events": { "type": "click", "markname": "last-button" }, "update": "maxPage" }
      ]
    },
    {
      "name": "originCount",
      "update": "length(data('originIndex')) || 0"
    },
    {
      "name": "maxPage",
      "update": "max(ceil(originCount / pageSize) - 1,0)"
    },
    {
      "name": "pageLabel",
      "update": "'Page ' + (page + 1) + ' of ' + (maxPage + 1)"
    }
  ],

  "data": [
    {
      "name": "raw",
      "url": "https://raw.githubusercontent.com/mawood33/kibana/refs/heads/main/data/flights-20k-ms.json",
      "format": { "type": "json"},
      "transform": [
        {
          "type": "formula",
          "as": "parsedDate",
          // Parse source date as local time
          // "2001/01/01 00:47" unless ISO standard YY:MM:DDTHH:MM:SS, datetime parses as local time
          // 1/1/2001 00:47 in datasource is treated as KST if you're in Korea, MST if in Colorado
          // parsedDate becomes 12/31/2000 15:47:00 GMT
          // "expr": "datetime(datum.date)"

          // Parse source datetime as UTC
          // 1/1/2001 00:00 in datasource is treated as GMT
          // parsedDate stays 1/1/2001 00:47:00 GMT
          // "expr": "utcParse(datum.date, '%Y/%m/%d %H:%M')"

          // Parse source datetime as milliseconds
          // 978353220000 becomes 1/1/2001 12:47:00 GMT
          // "expr": "utcParse(datum.date, '%Q')"

          // Parse source as UTC or milliseconds
          "expr": "if(utcParse(datum.date, '%Y/%m/%d %H:%M'), utcParse(datum.date, '%Y/%m/%d %H:%M'), if(utcParse(datum.date, '%Q'), utcParse(datum.date, '%Q'), 'Other'))"
        },
        {
          "type": "formula",
          "as": "day",
          "expr": "utc(year(datum.parsedDate), utcmonth(datum.parsedDate), utcdate(datum.parsedDate))"
        }
      ]
    },
    {
      "name": "dailyCounts",
      "source": "raw",
      "transform": [
        {
          "type": "aggregate",
          "groupby": ["origin", "day"],
          "ops": ["count"],
          "as": ["count"]
        },
        {
          "type": "joinaggregate",
          "groupby": [],
          "ops": ["max"],
          "fields": ["day"],
          "as": ["maxDate"]
        },
        {
          "type": "filter",
          "expr": "datum.day >= timeOffset('year', -1, datum.maxDate[0])"
        }
      ]
    },

    // Build a full originIndex (unfiltered) with whiskers and average
    {
      "name": "originIndex",
      "source": "dailyCounts",
      "transform": [
        {
          "type": "aggregate",
          "groupby": ["origin"],
          "fields": ["count", "count", "count"],
          "ops": ["min", "max", "average"],
          "as": ["Low", "High", "Avg"]
        },
        {
          "type": "collect",
          "sort": { "field": "origin", "order": "ascending" }
        },
        {
          "type": "window",
          "ops": ["row_number"],
          "as": ["row_number"]
        }
      ]
    },

    // Paginated set of origins
    {
      "name": "pagedOrigins",
      "source": "originIndex",
      "transform": [
        {
          "type": "filter",
          "expr": "datum.row_number > page * pageSize && datum.row_number <= (page + 1) * pageSize"
        }
      ]
    },

    // Data for whiskers & bands: filtered by pagedOrigins
    {
      "name": "minMaxPerOrigin",
      "source": "originIndex",
      "transform": [
        {
          "type": "lookup",
          "from": "pagedOrigins",
          "key": "origin",
          "fields": ["origin"],
          "as": ["match"]
        },
        {
          "type": "filter",
          "expr": "datum.match != null"
        }
      ]
    },

    // Data for 30 days avg, filtered by pagedOrigins
    {
      "name": "last30Days",
      "source": "dailyCounts",
      "transform": [
        {
          "type": "joinaggregate",
          "groupby": [],
          "ops": ["max"],
          "fields": ["day"],
          "as": ["maxDate"]
        },
        {
          "type": "filter",
          "expr": "datum.day >= timeOffset('day', now(), -30)"
        },
        {
          "type": "aggregate",
          "groupby": ["origin"],
          "ops": ["average"],
          "fields": ["count"],
          "as": ["avgCount"]
        },
        {
          "type": "lookup",
          "from": "pagedOrigins",
          "key": "origin",
          "fields": ["origin"],
          "as": ["match"]
        },
        {
          "type": "filter",
          "expr": "datum.match != null"
        }
      ]
    },

    // Data for last 24 hours, filtered by pagedOrigins
    {
      "name": "last24Hours",
      "source": "raw",
      "transform": [
        // {
        //   "type": "formula",
        //   "as": "parsedDate",
        //   "expr": "utcParse(datum.date, '%Y/%m/%d %H:%M')"
        // },
        {
          "type": "filter",
          "expr": "isValid(datum.parsedDate)"
        },
        // {
        //   "type": "window",
        //   "ops": ["max"],
        //   "fields": ["day"],
        //   "as": ["maxParsed"]
        // },
        {
          "type": "joinaggregate",
          "groupby": [],
          "ops": ["max"],
          "fields": ["parsedDate"],
          "as": ["maxDate"]
        },
        {
          "type": "filter",
          "expr": "datum.parsedDate >= utcParse(now() - 24 * 60 * 60 * 1000, '%Q')"
        },
        {
          "type": "joinaggregate",
          "groupby": ["origin", "day"],
          "ops": ["count"],
          "as": ["count24h"]
        },
        {
          "type": "lookup",
          "from": "pagedOrigins",
          "key": "origin",
          "fields": ["origin"],
          "as": ["match"]
        },
        {
          "type": "filter",
          "expr": "datum.match != null"
        }
      ]
    }
  ],

  "scales": [
    {
      "name": "y",
      "type": "band",
      "domain": { "data": "minMaxPerOrigin", "field": "origin" },
      "range": "height",
      "padding": 0.3
    },
    {
      "name": "x",
      "type": "linear",
      "domain": {
        "data": "originIndex",
        "fields": ["Low", "High"],
        "sort": true
      },
      "range": "width",
      "nice": true,
      "zero": false
    },
    {
      "name": "color",
      "type": "ordinal",
      "domain": { "data": "originIndex", "field": "origin" },
      "range": { "scheme": "category10" }
    }
  ],

  "axes": [
    { "orient": "bottom", "scale": "x", "title": "Flight Counts" },
    { "orient": "left", "scale": "y", "title": "Origin" }
  ],

  "legends": [
    { "fill": "color", "title": "Origin", "orient": "right" }
  ],

  "marks": [
    {
      "type": "group",
      "encode": {
        "enter": { "x": { "value": 0 }, "y": { "value": 0 } }
      },
      "marks": [
        {
          "type": "text",
          "name": "first-button",
          "encode": {
            "enter": {
              "x": { "value": 20 },
              "y": { "value": -30 },
              "text": { "value": "First" },
              "fill": { "value": "blue" },
              "cursor": { "value": "pointer" },
              "fontSize": { "value": 14 }
            },
            "hover": { "fill": { "value": "darkblue" } }
          }
        },
        {
          "type": "text",
          "name": "prev-button",
          "encode": {
            "enter": {
              "x": { "value": 90 },
              "y": { "value": -30 },
              "text": { "value": "Previous" },
              "fill": { "value": "blue" },
              "cursor": { "value": "pointer" },
              "fontSize": { "value": 14 }
            },
            "hover": { "fill": { "value": "darkblue" } }
          }
        },
        {
          "type": "text",
          "name": "next-button",
          "encode": {
            "enter": {
              "x": { "value": 190 },
              "y": { "value": -30 },
              "text": { "value": "Next" },
              "fill": { "value": "blue" },
              "cursor": { "value": "pointer" },
              "fontSize": { "value": 14 }
            },
            "hover": { "fill": { "value": "darkblue" } }
          }
        },
        {
          "type": "text",
          "name": "last-button",
          "encode": {
            "enter": {
              "x": { "value": 260 },
              "y": { "value": -30 },
              "text": { "value": "Last" },
              "fill": { "value": "blue" },
              "cursor": { "value": "pointer" },
              "fontSize": { "value": 14 }
            },
            "hover": { "fill": { "value": "darkblue" } }
          }
        },
        {
          "type": "text",
          "encode": {
            "enter": {
              "x": { "value": 350 },
              "y": { "value": -30 },
              "fill": { "value": "black" },
              "fontSize": { "value": 14 }
            },
            "update":{
                "text": { "signal": "pageLabel" }
            }
          }
        }
      ]
    },

    {
      "type": "rule",
      "from": { "data": "minMaxPerOrigin" },
      "encode": {
        "enter": {
          "strokeWidth": { "value": 3 },
          "opacity": { "value": 0.6 }
        },
        "update": {
          "x": { "scale": "x", "field": "Low" },
          "x2": { "scale": "x", "field": "High" },
          "y": { "scale": "y", "field": "origin", "offset": { "signal": "bandwidth('y')/2" } },
          "y2": { "scale": "y", "field": "origin", "offset": { "signal": "bandwidth('y')/2" } },
          "stroke": { "scale": "color", "field": "origin" },
          "tooltip": {
            "signal": "{'Origin': datum.origin, 'Low': datum.Low, 'High': datum.High}"
          }
        }
      },
      "transition": { "type": "fade", "duration": 300 }
    },

    {
      "type": "symbol",
      "from": { "data": "last30Days" },
      "encode": {
        "enter": {
          "size": { "value": 120 },
          "shape": { "value": "circle" },
          "stroke": { "value": "black" },
          "strokeWidth": { "value": 1 }
        },
        "update": {
          "x": { "scale": "x", "field": "avgCount" },
          "y": { "scale": "y", "field": "origin", "offset": { "signal": "bandwidth('y')/2" } },
          "fill": { "scale": "color", "field": "origin" },
          "tooltip": {
            "signal": "{'Origin': datum.origin, 'Avg (30d)': format(datum.avgCount, '.1f')}"
          }
        }
      },
      "transition": { "type": "fade", "duration": 300 }
    },

    {
      "type": "symbol",
      "from": { "data": "last24Hours" },
      "encode": {
        "enter": {
          "size": { "value": 180 },
          "shape": { "value": "circle" },
          "fill": { "value": "white" },
          "strokeWidth": { "value": 2 }
        },
        "update": {
          "x": { "scale": "x", "field": "count24h" },
          "y": { "scale": "y", "field": "origin", "offset": { "signal": "bandwidth('y')/2" } },
          "stroke": { "scale": "color", "field": "origin" },
          "tooltip": {
            "signal": "{'Origin': datum.origin, 'Count (24h)': datum.count24h}"
          }
        }
      },
      "transition": { "type": "fade", "duration": 300 }
    }
  ]
}
